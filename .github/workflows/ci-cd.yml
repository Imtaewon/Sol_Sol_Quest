name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [master, back-dev, rec-dev, front-dev]
  pull_request:
    branches: [master]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ğŸ” Lint with flake8
        run: |
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx

      - name: ğŸ§ª Run basic tests
        run: |
          pytest tests/ -v || echo "No tests found, continuing..."
          working-directory: ./backend  # â† ì¶”ê°€

  # 3ë‹¨ê³„: ë°±ì—”ë“œ ê°œë°œ ì„œë²„ ë°°í¬
  deploy-backend-dev:
    name: ğŸš€ Deploy Backend Development
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/back-dev'

    steps:
      - name: ğŸš€ Deploy to Backend Dev Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/Sol_Sol_Quest/backend
            git fetch origin
            git checkout back-dev
            git pull origin back-dev
            docker-compose down
            docker-compose up -d --build

            # ê°œì„ ëœ í—¬ìŠ¤ì²´í¬
            echo "â³ Waiting for backend service to start..."
            for i in {1..6}; do
              if curl -f http://localhost:8000 || curl -f http://localhost:8000/health; then
                echo "âœ… Backend development deployment successful"
                exit 0
              else
                echo "Health check attempt $i/6 failed, waiting..."
                sleep 10
              fi
            done
            echo "âš ï¸ Backend deployment completed but health check failed"

  # 4ë‹¨ê³„: ì¶”ì²œ ì‹œìŠ¤í…œ ë°°í¬
  deploy-rec-dev:
    name: ğŸ¤– Deploy Recommendation System
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/rec-dev'

    steps:
      - name: ğŸ¤– Deploy Recommendation System
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/Sol_Sol_Quest/backend
            git fetch origin
            git checkout rec-dev
            git pull origin rec-dev
            docker-compose down
            docker-compose up -d --build

            # ì¶”ì²œ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬
            echo "â³ Waiting for recommendation system to start..."
            for i in {1..6}; do
              if curl -f http://localhost:8000; then
                echo "âœ… Recommendation system deployment successful"
                exit 0
              else
                echo "Health check attempt $i/6 failed, waiting..."
                sleep 10
              fi
            done
            echo "âš ï¸ Recommendation deployment completed but health check failed"

  # 5ë‹¨ê³„: ìš´ì˜ ì„œë²„ ë°°í¬
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/master'

    steps:
      - name: ğŸŒŸ Deploy to Production Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/Sol_Sol_Quest/backend

            # ë°±ì—… ìƒì„±
            echo "ğŸ“¦ Creating backup..."
            docker tag backend-app:latest backend-app:backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "No previous image to backup"

            # ìƒˆ ë²„ì „ ë°°í¬
            echo "ğŸš€ Deploying new version..."
            git fetch origin
            git checkout master
            git pull origin master
            docker-compose down
            docker-compose up -d --build

            # ìš´ì˜ ì„œë²„ í—¬ìŠ¤ì²´í¬ (ë” ì—„ê²©)
            echo "â³ Waiting for production deployment..."
            for i in {1..10}; do
              if curl -f http://localhost:8000 && curl -f http://3.37.130.240; then
                echo "âœ… Production deployment successful"
                exit 0
              else
                echo "Production health check attempt $i/10 failed, waiting..."
                sleep 15
              fi
            done

            # ì‹¤íŒ¨ ì‹œ ë¡¤ë°± (ì„ íƒì‚¬í•­)
            echo "ğŸš¨ Production deployment failed, consider rollback"
            exit 1
