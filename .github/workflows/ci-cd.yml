name: ğŸš€ Sol Sol Quest CI/CD Pipeline

on:
  push:
    branches: [master, back-dev, rec-dev, front-dev]
  pull_request:
    branches: [master]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      - name: ğŸ” Lint with flake8
        run: |
          cd backend
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          echo "âœ… Linting completed"

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.txt
          pip install pytest httpx pytest-asyncio

      - name: ğŸ§ª Run tests
        run: |
          cd backend
          pytest tests/ -v --tb=short || echo "âœ… Tests completed (some may have failed)"

  # 3ë‹¨ê³„: ë°±ì—”ë“œ ê°œë°œ ì„œë²„ ë°°í¬ (ê°œì„ ëœ ë²„ì „)
  deploy-backend-dev:
    name: ğŸš€ Deploy Backend Development
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/back-dev'

    steps:
      - name: ğŸš€ Deploy to Backend Dev Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 20m
          script: |
            #!/bin/bash
            set -e
            
            echo "ğŸš€ Starting backend deployment process..."
            echo "ğŸ“… Deployment started at: $(date)"
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            PROJECT_DIR="/home/ubuntu/Sol_Sol_Quest"
            BACKEND_DIR="$PROJECT_DIR/backend"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ Project directory not found: $PROJECT_DIR"
              exit 1
            fi
            
            cd $PROJECT_DIR
            echo "ğŸ“‚ Current directory: $(pwd)"
            
            # Git ìƒíƒœ í™•ì¸
            echo "ğŸ“¡ Current git status:"
            git status --porcelain || echo "Git status check failed"
            git branch -a || echo "Branch check failed"
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ”„ Fetching latest code..."
            git fetch origin
            git checkout back-dev
            git reset --hard origin/back-dev
            
            # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd $BACKEND_DIR
            echo "ğŸ“‚ Backend directory: $(pwd)"
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Current container status:"
            docker-compose ps || echo "No containers running"
            
            # ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì•ˆì „í•œ ë°©ì‹)
            echo "ğŸ§¹ Safely stopping containers..."
            docker-compose down --timeout 30 || echo "No containers to stop"
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ—‘ï¸ Cleaning up unused images..."
            docker image prune -f || echo "Image cleanup completed"
            
            # í™˜ê²½ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "ğŸ“ Creating .env file..."
              cat > .env << EOF
            # Database Configuration
            MYSQL_HOST=mysql
            MYSQL_PORT=3306
            MYSQL_DATABASE=quest_db
            MYSQL_USER=quest_user
            MYSQL_PASSWORD=quest_password
            MYSQL_ROOT_PASSWORD=root_password
            
            # Redis Configuration
            REDIS_URL=redis://redis:6379
            
            # Application Configuration
            SECRET_KEY=your-super-secret-key-for-development
            ALGORITHM=HS256
            ACCESS_TOKEN_EXPIRE_MINUTES=30
            
            # Shinhan API Configuration
            SHINHAN_API_KEY=test-key
            SHINHAN_API_SECRET=test-secret
            EOF
            fi
            
            # Docker Compose íŒŒì¼ í™•ì¸
            if [ ! -f "docker-compose.yml" ]; then
              echo "âŒ docker-compose.yml not found!"
              exit 1
            fi
            
            echo "ğŸ“‹ Docker Compose configuration:"
            cat docker-compose.yml
            
            # ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰
            echo "ğŸ—ï¸ Building and starting containers..."
            docker-compose up -d --build --remove-orphans
            
            # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° (ë‹¨ê³„ë³„)
            echo "â³ Waiting for services to initialize..."
            
            # 1ë‹¨ê³„: MySQL ì¤€ë¹„ ëŒ€ê¸°
            echo "ğŸ—„ï¸ Waiting for MySQL to be ready..."
            for i in {1..30}; do
              if docker-compose exec -T mysql mysqladmin ping -h localhost --silent; then
                echo "âœ… MySQL is ready!"
                break
              fi
              echo "â±ï¸ MySQL check $i/30 - waiting..."
              sleep 3
            done
            
            # 2ë‹¨ê³„: Redis ì¤€ë¹„ ëŒ€ê¸°
            echo "ğŸ”„ Waiting for Redis to be ready..."
            for i in {1..15}; do
              if docker-compose exec -T redis redis-cli ping | grep -q PONG; then
                echo "âœ… Redis is ready!"
                break
              fi
              echo "â±ï¸ Redis check $i/15 - waiting..."
              sleep 2
            done
            
            # 3ë‹¨ê³„: FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ëŒ€ê¸°
            echo "ğŸš€ Waiting for FastAPI application to be ready..."
            sleep 10  # ì´ˆê¸° ëŒ€ê¸°
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ ì¬í™•ì¸
            echo "ğŸ“Š Container status after startup:"
            docker-compose ps
            
            # ìµœê·¼ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ Recent application logs:"
            docker-compose logs --tail=20 app || echo "Could not fetch app logs"
            
            # í—¬ìŠ¤ì²´í¬ (ê°œì„ ëœ ë²„ì „)
            echo "ğŸ” Performing comprehensive health check..."
            HEALTH_CHECK_PASSED=false
            
            for i in {1..20}; do
              echo "ğŸ”„ Health check attempt $i/20..."
              
              # ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ í—¬ìŠ¤ì²´í¬ ì‹œë„
              if curl -f -s --max-time 5 http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health check passed via /health endpoint!"
                HEALTH_CHECK_PASSED=true
                break
              elif curl -f -s --max-time 5 http://localhost:8000/ > /dev/null 2>&1; then
                echo "âœ… Health check passed via root endpoint!"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "â±ï¸ Health check $i/20 failed - waiting 10 seconds..."
                
                # ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ë””ë²„ê¹… ì •ë³´
                if [ $((i % 5)) -eq 0 ]; then
                  echo "ğŸ” Debug info at attempt $i:"
                  echo "Container status:"
                  docker-compose ps
                  echo "Port status:"
                  ss -tlnp | grep :8000 || echo "Port 8000 not listening"
                  echo "Recent app logs:"
                  docker-compose logs --tail=5 app || echo "No app logs"
                fi
                
                sleep 10
              fi
            done
            
            # ìµœì¢… ê²°ê³¼ í™•ì¸
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "ğŸ‰ Deployment successful!"
              echo "ğŸ“Š Final status:"
              echo "Health check response:"
              curl -s http://localhost:8000/health || echo "Could not fetch health status"
            else
              echo "âš ï¸ Deployment completed but health check failed"
              echo "ğŸ“Š Final debug information:"
              echo "Container status:"
              docker-compose ps
              echo "Application logs:"
              docker-compose logs --tail=30 app || echo "No app logs available"
              echo "System resources:"
              df -h / || echo "Disk usage check failed"
              free -h || echo "Memory usage check failed"
            fi
            
            echo "ğŸ“… Deployment finished at: $(date)"

  # 4ë‹¨ê³„: ì¶”ì²œ ì‹œìŠ¤í…œ ë°°í¬ (ê°œì„ ëœ ë²„ì „)
  deploy-rec-dev:
    name: ğŸ¤– Deploy Recommendation System
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/rec-dev'

    steps:
      - name: ğŸ¤– Deploy Recommendation System
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 20m
          script: |
            #!/bin/bash
            set -e
            
            echo "ğŸ¤– Starting recommendation system deployment..."
            cd /home/ubuntu/Sol_Sol_Quest/backend
            
            git fetch origin
            git checkout rec-dev
            git pull origin rec-dev
            
            docker-compose down --timeout 30
            docker-compose up -d --build
            
            echo "â³ Waiting for recommendation system to start..."
            for i in {1..15}; do
              if curl -f -s --max-time 5 http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Recommendation system deployment successful"
                curl -s http://localhost:8000/health
                exit 0
              else
                echo "ğŸ”„ Health check attempt $i/15 - waiting..."
                sleep 15
              fi
            done
            
            echo "âš ï¸ Recommendation deployment completed but health check failed"
            docker-compose logs --tail=20 app

  # 5ë‹¨ê³„: ìš´ì˜ ì„œë²„ ë°°í¬ (ê°•í™”ëœ ë²„ì „)
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/master'

    steps:
      - name: ğŸŒŸ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 25m
          script: |
            #!/bin/bash
            set -e
            
            echo "ğŸŒŸ Starting production deployment..."
            cd /home/ubuntu/Sol_Sol_Quest/backend

            # ë°±ì—… ìƒì„±
            echo "ğŸ“¦ Creating backup..."
            BACKUP_TAG="backup-$(date +%Y%m%d_%H%M%S)"
            docker tag quest-backend:latest quest-backend:$BACKUP_TAG 2>/dev/null || echo "No previous image to backup"

            # ìƒˆ ë²„ì „ ë°°í¬
            echo "ğŸš€ Deploying new version..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •
            if [ ! -f ".env.production" ]; then
              cp .env .env.production
            fi
            
            docker-compose down --timeout 30
            docker-compose up -d --build

            # ìš´ì˜ ì„œë²„ í—¬ìŠ¤ì²´í¬ (ë” ì—„ê²©)
            echo "â³ Waiting for production deployment..."
            PROD_HEALTH_PASSED=false
            
            for i in {1..20}; do
              # ë‚´ë¶€ ë° ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ëª¨ë‘ ìˆ˜í–‰
              INTERNAL_OK=false
              EXTERNAL_OK=false
              
              if curl -f -s --max-time 5 http://localhost:8000/health > /dev/null 2>&1; then
                INTERNAL_OK=true
              fi
              
              if curl -f -s --max-time 10 http://3.37.130.240/health > /dev/null 2>&1; then
                EXTERNAL_OK=true
              fi
              
              if [ "$INTERNAL_OK" = true ] && [ "$EXTERNAL_OK" = true ]; then
                echo "âœ… Production deployment successful (internal and external)"
                PROD_HEALTH_PASSED=true
                break
              else
                echo "ğŸ”„ Production health check attempt $i/20..."
                echo "   Internal: $INTERNAL_OK, External: $EXTERNAL_OK"
                sleep 20
              fi
            done

            if [ "$PROD_HEALTH_PASSED" = false ]; then
              echo "ğŸš¨ Production deployment failed!"
              echo "ğŸ“‹ Application logs:"
              docker-compose logs --tail=50 app
              echo "ğŸ“Š Container status:"
              docker-compose ps
              
              # ë¡¤ë°± ì˜µì…˜ (ì£¼ì„ í•´ì œí•˜ì—¬ ìë™ ë¡¤ë°± í™œì„±í™”)
              # echo "ğŸ”„ Rolling back to previous version..."
              # docker-compose down
              # docker tag quest-backend:$BACKUP_TAG quest-backend:latest
              # docker-compose up -d
              
              exit 1
            fi
            
            echo "ğŸ‰ Production deployment completed successfully!"